class DemoAMap{constructor(e,t,i){this.demo=demo,this.option=demo.copy(Object.assign({icons:[]},t||{}));let l=null;if(!AMap.v||!this.demo.version)return l=this.code("AMap OR demo is null"),i&&i(l),l;if(e=e||"#map",this.id=e,this.ids=e.replace("#",""),!this.demo.$.id(this.ids))return l=this.code("dom is null"),i&&i(l),l;let o=function(e){let t={rotation:0,features:["bg","road"],showBuildingBlock:!0,zoom:e.zoom||13};return e.layer&&e.layer.length&&e.layer.indexOf(3)>=0&&(t.viewMode="3D",t.pitch=60),t};this.map=new AMap.Map(this.ids,o(this.option)),this._init(),i&&i(this.code("success",1,{map:this.map}))}code(e,t,i){return{err:e,code:t||0,data:i||{}}}style(e,t){let i=this;if(!i.map)return;let l=(e,t)=>({label:e,value:t}),o=[l("默认","normal"),l("幻影黑","dark"),l("月光银","light"),l("远山黛","whitesmoke"),l("草色青","fresh"),l("雅士灰","grey"),l("涂鸦","graffiti"),l("马卡龙","macaron"),l("靛青蓝","blue"),l("极夜蓝","darkblue"),l("酱籽","wine")],a=o.filter((t,i)=>isNaN(e)?t.value===e:i===+e);if(!e||!a.length){let e=o.map((e,t)=>(e.id=t,e));return t&&t(i.code("",0,e)),e}a=a[0],t&&t(i.code("",1,a)),this.map.setMapStyle("amap://styles/"+a.value)}features(e,t){if(!e)return["bg","point","road","building"];if(!this.map)return;let i=this.map.getFeatures(),l=i.indexOf(e)>=0;if(t){if(!l)return;i=i.filter(t=>t!==e)}else{if(l)return;i.push(e)}this.map.setFeatures(i)}_init(){this.use={polygon:!1,circle:!1,circular:!1},this.list={polygon:[],polygonEdit:[],circle:[],layer:[],model:[],circular:[],circularEdit:[]},this.status={type:""},this.layer(this.option),this.icons=this.option.icons||[],this.version="0.07",this.updateTime="2021/06/24 18:00:00",this.createTime="2021/05/10 10:00:00"}_use_reset(e){for(let e in this.use)this.use[e]=!1;7!==this.demo._is_obj(this.use[e]).code&&(this.use[e]=!0)}_filter_list(e,t,i){let l=(this.list[e].filter(e=>e[i||"id"]===t)[0]||{}).event;return l}_lngLat(e){let t={lng:e.lnglat.getLng(),lat:e.lnglat.getLat()};return t.path=[t.lng,t.lat],t}center(e,t){this.map.setCenter([e,t])}model(e,t,i){let l=this;e=e||{};let o=null;if(!e.lng||!e.lat)return o=l.code("定位出错：经纬度不存在"),t&&t(o),o;let a=e.id||"a-map-model-"+l.demo.rand(4);var n=new AMap.InfoWindow({isCustom:!0,anchor:e.map_dire||"bottom-left",content:i?i(e,a):"这是信息窗体",offset:new AMap.Pixel(-20,-40)});n.open(this.map,[+e.lng,+e.lat]);let c={event:n,opt:e,id:Date.now()+"-"+l.demo.rand(4)};return l.list.model.push(c),setTimeout(()=>{let e=l.demo.js("#"+a);if(e.dom){c.dom=e;let i=e.find(".close");i&&l.demo.js(i,0).click(()=>{n.close(),l.list.model=l.list.model.filter(e=>e.id!==c.id),t&&t(l.code("close",2,{}))}),t&&t(l.code("",1,c))}},800),c}modelDelAll(){let e=this;return e.list.model.length&&(e.list.model.forEach(e=>{e.event.close()}),setTimeout(()=>{e.list.model=[]},200)),e}layer(e,t){let i=this,l=["实时路况","路网","卫星","楼块"],o=i.list.layer||[];return o.length&&(o.forEach(e=>{i.map.remove(e.event)}),i.list.layer=[]),e.layer&&e.layer.length&&(e.layer.forEach(e=>{let t=null;switch(+e){case 0:t=new AMap.TileLayer.Traffic;break;case 1:t=new AMap.TileLayer.RoadNet;break;case 2:t=new AMap.TileLayer.Satellite;break;case 3:t=new AMap.Buildings({zooms:[16,18],heightFactor:2,opacity:.5}),i.map.setPitch(60)}i.list.layer.push({id:+e,event:t})}),i.map.add(i.list.layer.map(e=>e.event)),t&&t()),l.map((e,t)=>({id:t,text:e}))}circle_check_ico(e){let t=this,i=t.icons.filter(t=>t.name===e&&t.offset.length)[0]||{},l={name:i.name};return i.name&&(l.icon=i.icon,l.offset=new AMap.Pixel(i.offset[0]||0,i.offset[1]||0)),l}circle_dot(e,t,i){let l=this,o=l.circle_check_ico(t);o.name&&(l.circleAll(i,function(e,t){t.length&&t.forEach(e=>{let t=l.circle_check_ico(e.data.opt.iconName);t.name&&(e.event.setIcon(t.icon),e.event.setOffset(t.offset))})}),e.setIcon(o.icon),e.setOffset(o.offset))}_circle_handler(e,t,i){let l=this,o=function(e){let o=e.id||"circle-"+Date.now(),a={position:new AMap.LngLat(e.lng,e.lat),title:e.title||"",extData:{id:o,opt:e}},n=l.circle_check_ico(e.iconName);n.name&&(a.icon=n.icon,a.offset=n.offset);var c=new AMap.Marker(a);l.map.add(c);let r={id:o,event:c,type:e.type,data:c.getExtData()};if(l.list.circle.push(r),e.label){let t=e.labelData||{offset:new AMap.Pixel(0,0),content:"<div data-amap-circle-label>"+e.label+"</div>",direction:"center"};c.setLabel(t)}c.on("click",()=>{l.center(e.lng,e.lat),t&&t(r)}),i&&t&&t(r)};if(e.pointer)o(e);else{let t=l._lngLat(e);o(Object.assign(e,{type:"circle",title:"新的"},t))}}circle(e,t){let i=this;if(e=e||{},i._use_reset("circle"),i.use.polygon=!!e.polygon,e.close)return i.map.off("click",i._circle_handler),i._use_reset(""),i.use.polygon=!!e.polygon,0;if(e.lng&&e.lat)if("polygon"===e.type){let t=e.newPath[e.newPath.length-1];this._circle_handler(Object.assign(e,t,{pointer:1}))}else 4===i.demo._is_obj(e.lng).code?e.lng.forEach((i,l)=>{this._circle_handler({lng:i,lat:e.lat[l],type:e.type,pointer:1},e=>{t&&t(e)})}):(e.pointer=1,this._circle_handler(e,e=>{t&&t(e)}));else{if(e.clear&&i.circleDel("circle"),e.close)return 0;i.map.on("click",i._circle_handler,i)}}circleDel(e){let t=this;t.list.circle.filter(t=>t.type===e).forEach(e=>{t.map.remove(e.event)}),t.list.circle=t.list.circle.filter(t=>t.type!==e)}circleAll(e,t){let i=this,l=[],o=[];return i.circle({close:1}),i.list.circle.filter(t=>t.type===e).map(e=>e.event).forEach(e=>{let t=e.getExtData();l.push(t),o.push({event:e,data:t})}),t&&t(l,o),l}polygon(e,t){let i=this;i._use_reset("polygon"),i.circle({close:1}),i.status.type="polygon",e=e||{};let l=[],o=function(e){a(i._lngLat(e))},a=function(a){l.push(a);let c=i.demo.array(l.map(e=>e.lng)).unique(),r=i.demo.array(l.map(e=>e.lat)).unique();return c.length!==l.length?(t&&t(i.code("经度不可选同一个点")),l.splice(-1,1),0):r.length!==l.length?(t&&t(i.code("纬度不可选同一个点")),l.splice(-1,1),0):"polygon"!==i.status.type?(i.map.off("click",o),0):(i.circle({polygon:1,lng:c,lat:r,opt:e,newPath:l,type:"polygon"}),void(l.length>=3&&(i.map.off("click",o),n(l.map(e=>e.path),e),i.circleDel("polygon"),l=[])))},n=function(e,l){let o=Date.now(),a=l.poyConfig||{};var n=new AMap.Polygon({path:e,fillColor:a.color||"#fff",fillOpacity:.5,strokeOpacity:a.opacity||.6,strokeWeight:a.lineWidth||2,strokeColor:a.line||"cyan",extData:{path:e,opt:l,id:o}});i.map.add(n),i.map.setFitView([n]);var c=new AMap.PolyEditor(i.map,n);c.open(),i.list.polygon.push({id:o,event:n}),i.list.polygonEdit.push({id:o,event:c}),i.use.polygon=!0,t&&t(i.code("success",1,{id:o,area:n.getArea(),path:n.getPath().map(e=>({lng:e.lng,lat:e.lat})),data:l,event:n,edit:c}))};e.path&&e.path.length>=3?n(e.path,e):i.map.on("click",o)}polygonEnd(e,t){let i=this;if(!i.use.polygon)return t&&t(i.code("polygon no edit")),0;e=e||{};let l=i._filter_list("polygonEdit",e.id);if(!l)return 0;l.close();let o=i._filter_list("polygon",e.id),a=function(){l.open(),i.use.polygon=!0,o.off("click",a)};i.use.polygon=!1,e.click&&o.on("click",a)}polygonSubmit(e,t,i){let l=this;i||l.polygonEnd(e);let o=l._filter_list("polygon",e.id);if(!o)return t&&t(l.code("event is undefined")),0;let a={path:o.getPath().map(e=>({lng:e.lng,lat:e.lat})),area:o.getArea()};return t&&t(this.code("",1,a)),a}polygonDel(e,t){let i=this;i.polygonEnd(e);let l=i._filter_list("polygon",e.id);if(!l)return t&&t(i.code("event is undefined")),0;i.map.remove(l),t&&t(this.code("",1))}polygonGets(e,t){let i=this,l=i._filter_list("polygonEdit",e);if(!l)return 0;l.on("adjust",function(){i.polygonSubmit({id:e},e=>{t&&t(i.code(e.err,e.code,e.data))},!0)})}polygonOption(e){let t=this;e=e||{};let i=t._filter_list("polygon",e.id);if(!i)return 0;let l=e.config||{};return i.setOptions({fillColor:l.color||"#fff",fillOpacity:l.bgcOpacity||.5,strokeOpacity:l.opacity||.6,strokeWeight:l.lineWidth||2,strokeColor:l.line||"cyan"}),i.getOptions()}polygonDelAll(){let e=this;return e.list.polygon.length&&e.list.polygon.forEach(t=>{e.map.remove(t.event)}),e}circular(e,t){let i=this;i._use_reset("circular"),i.circle({close:1}),i.status.type="circular",e=e||{};let l=[],o=function(e){a(i._lngLat(e))},a=function(a){l.push(a);let c=i.demo.array(l.map(e=>e.lng)).unique(),r=i.demo.array(l.map(e=>e.lat)).unique();return c.length!==l.length?(t&&t(i.code("经度不可选同一个点")),l.splice(-1,1),0):r.length!==l.length?(t&&t(i.code("纬度不可选同一个点")),l.splice(-1,1),0):"circular"!==i.status.type?(i.map.off("click",o),0):(i.circle({polygon:1,lng:c,lat:r,opt:e,newPath:l,type:"circular"}),void(l.length>=1&&(i.map.off("click",o),n(l[0].path,e),i.circleDel("circular"),l=[])))},n=function(e,l){let o=Date.now(),a=l.poyConfig||{};var n=new AMap.Circle({center:new AMap.LngLat(e[0],e[1]),radius:l.radius||300,fillColor:a.color||"#fff",fillOpacity:.5,strokeOpacity:a.opacity||.6,strokeWeight:a.lineWidth||2,strokeColor:a.line||"cyan",extData:{path:e,opt:l,id:o}});i.map.add(n),i.map.setFitView([n]);let c=new AMap.CircleEditor(i.map,n);c.open(),i.list.circular.push({id:o,event:n}),i.list.circularEdit.push({id:o,event:c}),i.use.circular=!0,t&&t(i.code("success",1,{id:o,path:n.getPath().map(e=>({lng:e.lng,lat:e.lat})),data:l,event:n,edit:c}))};e.lng&&e.lat?n([e.lng,e.lat],e):i.map.on("click",o)}circularEnd(e,t){let i=this;if(!i.use.circular)return t&&t(i.code("circular no edit")),0;e=e||{};let l=i._filter_list("circularEdit",e.id);if(!l)return 0;l.close();let o=i._filter_list("circular",e.id),a=function(){l.open(),i.use.circular=!0,o.off("click",a)};i.use.circular=!1,e.click&&o.on("click",a)}circularSubmit(e,t,i){let l=this;i||l.circularEnd(e);let o=l._filter_list("circular",e.id);if(!o)return t&&t(l.code("event is undefined")),0;let a={path:o.getCenter(),radius:o.getRadius(),data:o.getExtData()};return t&&t(this.code("",1,a)),a}circularDel(e,t){let i=this;i.circularEnd(e);let l=i._filter_list("circular",e.id);if(!l)return t&&t(i.code("event is undefined")),0;i.map.remove(l),t&&t(this.code("",1))}circularGets(e,t){let i=this,l=i._filter_list("circularEdit",e);if(!l)return 0;l.on("adjust",function(){i.polygonSubmit({id:e},e=>{t&&t(i.code(e.err,e.code,e.data))},!0)})}circularOption(e){let t=this;e=e||{};let i=t._filter_list("circular",e.id);if(!i)return 0;let l=e.config||{},o={fillColor:l.color||"#fff",fillOpacity:l.bgcOpacity||.5,strokeOpacity:l.opacity||.6,strokeWeight:l.lineWidth||2,strokeColor:l.line||"cyan"};return l.radius&&(o.radius=l.radius),l.center&&2===l.center.length&&(o.center=l.center),l.lng&&l.lat&&(o.center=[l.lng,l.lat]),i.setOptions(o),i.getOptions()}circularDelAll(){let e=this;return e.list.circular.length&&e.list.circular.forEach(t=>{e.map.remove(t.event)}),e}ip(e){let t=this;AMap.plugin("AMap.CitySearch",function(){var i=new AMap.CitySearch;i.getLocalCity(function(i,l){"complete"===i&&"OK"===l.info?e&&e(t.code("",1,{code:l.adcode,city:l.city,province:l.province})):e&&e(t.code(i+":"+JSON.stringify(l),0,{status:i,result:l}))})})}address(e,t){e=e||{};let i=this,l=function(l){AMap.plugin("AMap.Geocoder",function(){var o=new AMap.Geocoder({city:l}),a=e.path||[0,0];o.getAddress(a,function(o,n){if("complete"===o&&"OK"===n.info){let o={address:n.regeocode.formattedAddress,detail:n.regeocode.addressComponent,path:a,ext:e,city:l};t&&t(i.code("",1,o))}else t&&t(i.code(o,0,{status:o,result:n}))})})};e.code?l(e.code):i.ip(e=>{e.code?l(e.data.code):i.demo.log(e.err)})}poi(e,t){e=e||{};let i=this,l=function(l){var o=new AMap.PlaceSearch({city:l,pageSize:e.limit||10,pageIndex:e.page||1,citylimit:e.citylimit||!1});o.search(e.search,function(o,a){if("complete"===o&&"OK"===a.info){let o=a.poiList||{},n={count:o.count,total:Math.ceil(o.count/o.pageSize),limit:o.pageSize,page:o.pageIndex,list:(o.pois||[]).filter(e=>e.name&&e.address&&3===i.demo._is_obj(e.address).code).map(e=>(e.lng=(e.location||{}).lng,e.lat=(e.location||{}).lat,e.title=e.name,e)),city:l,ext:e,search:e.search};o=null,t&&t(i.code("",1,n))}else t&&t(i.code(o,0,{status:o,result:a}))})};e.code?l(e.code):i.ip(e=>{e.code?l(e.data.code):i.demo.log(e.err)})}zoom(e){let t=this.map.getZooms(),i=this.map.getZoom(),l=e?i+=1:i-=1;return l=l>=t[1]?t[1]:l<=t[0]?t[0]:l,this.map.setZoom(l),l}}